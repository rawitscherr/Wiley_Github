(void 0===window.QSI.PopOver||window.QTest)&&(QSI.PopOver=QSI.util.Creative(QSI.BuildElementModule,{initialize:function(a){this.globalInitialize(a),this.minTop=a.elements.MinTop,this.minLeft=a.elements.MinLeft,this.elements=a.elements.Elements||[],this.imageQueue=0,this.loaded=!1,this.timeout=!1,this.hasCreativeEmbeddedTarget=a.hasCreativeEmbeddedTarget,this.shouldShow()&&(this.addMessageListener(),QSI.util.processLocators(this.elements,this.options.displayOptions),this.container=this.build(),document.body.appendChild(this.container),this.display())},addMessageListener:function(){var a=this;this.displayOptions.autoClose&&QSI.util.observe(window,"message",function(b){"closeQSIWindow"==b.data&&a.close()})},display:function(){var a=this;this.displayOptions.auto&&(this.displayOptions.prebuild?(this.initializeIframes(),QSI.util.when(this.container.loadingDeferred,QSI.util.getTimeout(this.displayOptions.delay)).done(function(){a.popup(),a.poppedUp=!0})):QSI.util.when(QSI.util.getTimeout(this.displayOptions.delay)).done(function(){a.popup(),a.poppedUp=!0}))},close:function(){try{this.refocus(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.displayOptions.shadowBox&&this.shadowBox&&this.shadowBox.parentNode&&(this.shadowBox.parentNode.removeChild(this.shadowBox),QSI.util.startScrolling()),QSI.util.stopObserving(window,"resize",this.resizeHandler),QSI.callbacks&&QSI.callbacks[this.id]&&QSI.callbacks[this.id].onClose&&QSI.callbacks[this.id].onClose()}catch(a){}},refocus:function(){try{if(this.hasIframe&&QSI.util.isIE8()){var a=document.body.scrollTop,b=document.body.scrollLeft,c=QSI.util.build("input",{type:"text"});document.body.appendChild(c),c.focus(),document.body.removeChild(c),window.scrollTo(b,a)}}catch(d){}},popup:function(){try{this.resetStyles();var a=1e3*this.displayOptions.close,b=this;if(0!==a&&this.displayed.done(function(){window.setTimeout(function(){b.close()},a)}),this.impress(),!this.displayOptions.prebuild){this.initializeIframes();var c=this.container.getElementsByClassName("scrollable")[0];if(c&&this.hasCreativeEmbeddedTarget){var d=75,e=parseInt(c.style.height,10),f=parseInt(c.style.width,10),g=e/2-d/2,h=f/2-d/2,i=new QSI.LoadingAnimationElement,j=i.buildAnimation(d,g,h);c.appendChild(j),i.startAnimation(100),QSI.util.when(this.container.loadingDeferred).done(function(){i.stopAnimation()})}}this.displayOptions.shadowBox&&(this.shadowBox=this.buildShadowBox(),QSI.util.stopScrolling(),document.body.appendChild(this.shadowBox),this.displayOptions.shadowBoxFade&&QSI.Animation.animateStyle(this.shadowBox,{from:{opacity:0},to:{opacity:this.displayOptions.shadowBoxOpacity}},500,"linear")),this.container.style.zIndex=QSI.global.currentZIndex++;var k=this.getFinalPosition();if(this.displayOptions.animate){var l=this.getStartPosition(),m=QSI.Animation.animateStyle(this.container,{from:{top:l.y,left:l.x},to:{top:k.y,left:k.x}},this.displayOptions.duration,this.displayOptions.transition);m.done(function(){b.target={x:k.x,y:k.y},b.finish()})}else this.target={x:k.x,y:k.y},this.finish();this.resizeHandler=function(){b.resize()},QSI.util.observe(window,"resize",this.resizeHandler)}catch(n){QSI.dbg.e(n)}},getYPosition:function(a){return a.top-this.minTop},getXPosition:function(a){return a.left-this.minLeft},getElementStyle:function(a,b){return{top:this.getYPosition(b)+"px",left:this.getXPosition(b)+"px",position:"absolute",zIndex:a.zIndex,width:a.width+"px",height:a.height+"px",backgroundColor:a.backgroundColor,borderWidth:a.borderWidth+"px",borderColor:a.borderColor,borderStyle:"solid",borderRadius:a.borderRadius+"px",display:a.display}},buildShadowBox:function(){var a=this.displayOptions.shadowBoxOpacity,b=this.displayOptions.shadowBoxColor,c=QSI.util.getPageSize(),d=c.width,e=c.height,f=QSI.util.getScrollOffsets(),g=QSI.util.build("div",{style:{position:"absolute",backgroundColor:b,left:f.left+"px",top:f.top+"px",width:d+"px",height:e+"px",opacity:a,zIndex:QSI.global.currentZIndex++,filter:"alpha(opacity="+100*a+")"}});return g},updateShadowBox:function(){if(this.shadowBox){var a=QSI.util.getPageSize(),b=a.width,c=a.height;this.shadowBox.style.width=b+"px",this.shadowBox.style.height=c+"px"}},build:function(){for(var a=[],b=0,c=0,d=0,e=[],f=0,g=this.elements.length;g>f;f++){var h=this.buildElement(this.elements[f]);h&&(h.style&&h.style.borderWidth&&(d=2*parseInt(h.style.borderWidth,10)),h.bc&&h.bc.x+d>b&&(b=h.bc.x+d),h.bc&&h.bc.y+d>c&&(c=h.bc.y+d),a.push(h),e.push(h.loadingDeferred))}this.width=b,this.height=c;var i=Math.floor(1.2*this.width),j=Math.floor(1.2*this.height),k="fixed";QSI.util.isFixed()||(k="absolute");var l=QSI.util.build("div",{className:"QSIPopOver "+this.id+"_PopOverContainer",style:{position:k,top:-j+"px",left:-i+"px"}},a);return l.loadingDeferred=QSI.util.when.apply(this,e),l},getFinalPosition:function(){var a=this.width,b=this.height,c=QSI.util.getScrollOffsets(),d=QSI.util.getPageSize(),e=d.width,f=d.height;a>e&&(a=e),b>f&&(b=f);var g=this.displayOptions.targetPosition,h=20,i=(e-a)/2,j=(f-b)/2;switch(g){default:case"MC":i=(e-a)/2,j=(f-b)/2;break;case"ML":i=h,j=(f-b)/2;break;case"TL":i=h,j=h;break;case"BL":i=h,j=f-b-h;break;case"TC":i=(e-a)/2,j=h;break;case"TR":i=e-a-h,j=h;break;case"MR":i=e-a-h,j=(f-b)/2;break;case"BR":i=e-a-h,j=f-b-h;break;case"BC":i=(e-a)/2,j=f-b-h}return QSI.util.isFixed()||(i+=c.left,j+=c.top),{x:i,y:j}},getStartPosition:function(){var a=this.width,b=this.height,c=QSI.util.getPageSize(),d=QSI.util.getScrollOffsets(),e=c.width,f=c.height,g=20,h=this.displayOptions.startPosition,i=-a,j=(f-b)/2;switch(h){default:case"OML":i=-a,j=(f-b)/2;break;case"OTL":i=-a,j=-b;break;case"OTLL":i=-a,j=g;break;case"OTLT":i=g,j=-b;break;case"OBL":i=-a,j=f;break;case"OBLL":i=-a,j=f-b-g;break;case"OBLB":i=g,j=f;break;case"OTC":i=(e-a)/2,j=-b;break;case"OTR":i=e,j=-b;break;case"OTRR":i=e,j=g;break;case"OTRT":i=e-a-g,j=-b;break;case"OMR":i=e,j=(f-b)/2;break;case"OBR":i=e,j=f;break;case"OBRR":i=e,j=f-b-g;break;case"OBRB":i=e-a-g,j=f;break;case"OBC":i=(e-a)/2,j=f}return QSI.util.isFixed()||(i+=d.left,j+=d.top),{x:i,y:j}},finish:function(){if(!this.finished){this.displayed.resolve();try{this.container.style.left=this.target.x+"px",this.container.style.top=this.target.y+"px",this.finished=!0,QSI.callbacks&&QSI.callbacks[this.id].onPopup&&QSI.callbacks[this.id].onPopup(),QSI.util.isFixed()||QSI.util.positionFixed(this.container,this.container.style.top,"auto")}catch(a){QSI.dbg.e(a)}}},reposition:function(){var a=this.getFinalPosition();this.container.style.left=a.x+"px",this.container.style.top=a.y+"px"},resize:function(){this.reposition(),this.updateShadowBox()}}));
